<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoofingMilk Mint</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: #ffffff;
            color: #333333;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 400px;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333333;
        }
        .input-box {
            margin-bottom: 15px;
        }
        .input-box label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #333333;
        }
        .input-box input, .input-box select {
            padding: 10px;
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 5px;
            color: #333333;
            font-size: 1em;
            width: 100%;
        }
        .custom-select {
            position: relative;
            width: 100%;
        }
        .select-selected {
            padding: 10px;
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 5px;
            color: #333333;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .select-selected img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        .select-items {
            position: absolute;
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 5px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 99;
            display: none;
        }
        .select-items div {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .select-items div img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
        .select-items div:hover {
            background: #f0f0f0;
        }
        .select-items.show {
            display: block;
        }
        .action-button {
            padding: 12px;
            background: #28a745;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background 0.2s;
            position: relative;
        }
        .action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .action-button:hover:not(:disabled) {
            background: #218838;
        }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top: 2px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 5px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .log-box {
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.85em;
            color: #333333;
            margin-bottom: 15px;
        }
        .log-box p {
            margin: 5px 0;
            word-break: break-all;
        }
        .log-box .error {
            color: #dc3545;
        }
        .log-box .success {
            color: #28a745;
        }
        @media (max-width: 480px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .header { font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">WoofingMilk Mint</div>
        <div class="input-box">
            <label>Private Key</label>
            <input type="password" id="privateKeyInput" placeholder="Enter your private key">
        </div>
        <div class="input-box">
            <label>Gas Limit</label>
            <input type="number" id="gasLimit" value="10000000" min="21000">
        </div>
        <div class="input-box">
            <label>Select Whitelisted Token</label>
            <div class="custom-select">
                <div class="select-selected">
                    <img src="" alt="" style="display: none;">
                    Select a token
                </div>
                <div class="select-items">
                    <div data-value="0xe9Cb2D7ADC24Fc59FE00D6C0A0669BDF16805Fe0" data-logo="https://woofswap.finance/image/tokens/feed.png">
                        <img src="https://woofswap.finance/image/tokens/feed.png" alt="FEED"> FEED
                    </div>
                    <div data-value="0x61CFA29261d8151D39244b8FfCf8DFd2f9DF3839" data-logo="https://woofswap.finance/image/tokens/ChikaLogo.png">
                        <img src="https://woofswap.finance/image/tokens/ChikaLogo.png" alt="CHIKA"> CHIKA
                    </div>
                    <div data-value="0xD0daa7B6ff1B40d3cc6F0B2Cf7E85cB993D1c834" data-logo="https://woofswap.finance/image/tokens/WOOF.png">
                        <img src="https://woofswap.finance/image/tokens/WOOF.png" alt="WOOF"> WOOF
                    </div>
                    <div data-value="0xeCe898EdCc0AF91430603175F945D8de75291c70" data-logo="https://woofswap.finance/image/tokens/DAMN.png">
                        <img src="https://woofswap.finance/image/tokens/DAMN.png" alt="DAMN"> DAMN
                    </div>
                    <div data-value="0x8f4b11d923BbAA6206f3Dd3ff84e8e31bafB49b7" data-logo="https://woofswap.finance/image/tokens/wow.png">
                        <img src="https://woofswap.finance/image/tokens/wow.png" alt="WOW"> WOW
                    </div>
                    <div data-value="0xB820c8a74c8E4059661460C414821bC5820470D8" data-logo="https://woofswap.finance/image/tokens/toys.png">
                        <img src="https://woofswap.finance/image/tokens/toys.png" alt="TOYS"> TOYS
                    </div>
                </div>
            </div>
        </div>
        <button class="action-button" id="startButton">Start Minting</button>
        <button class="action-button" id="stopButton" style="display: none;">Stop Minting</button>
        <div class="log-box" id="logBox"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
    <script>
        const momongaAddress = '0x48f1efa7Fa5b124FF6E0E7dEDcE402a810c81791';
        const momongaAbi = [
            {
                "inputs": [{"internalType": "address", "name": "targetToken", "type": "address"}],
                "name": "mint",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "address", "name": "token", "type": "address"},
                    {"indexed": true, "internalType": "address", "name": "recipient", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "Airdrop",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": false, "internalType": "string", "name": "reason", "type": "string"}
                ],
                "name": "MintFailed",
                "type": "event"
            }
        ];

        const RPC_ENDPOINT = 'https://www.shibrpc.com';
        const GAS_PRICE_MIN_GWEI = '0.001';
        const GAS_PRICE_MAX_GWEI = '5';
        let web3 = new Web3(RPC_ENDPOINT);
        let account, momongaContract;
        let selectedToken = '';
        let isMinting = false;

        function appendLog(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const logEntry = document.createElement('p');
            logEntry.className = type;
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            logBox.appendChild(logEntry);
            logBox.scrollTop = logBox.scrollHeight;
        }

        function initializeCustomSelect() {
            const select = document.querySelector('.custom-select');
            const selected = select.querySelector('.select-selected');
            const items = select.querySelector('.select-items');
            const options = items.querySelectorAll('div');

            selected.addEventListener('click', () => {
                items.classList.toggle('show');
            });

            options.forEach(option => {
                option.addEventListener('click', () => {
                    selected.innerHTML = option.innerHTML;
                    selectedToken = option.getAttribute('data-value');
                    items.classList.remove('show');
                    updateButtons();
                });
            });

            document.addEventListener('click', (e) => {
                if (!select.contains(e.target)) {
                    items.classList.remove('show');
                }
            });
        }

        function updateButtons() {
            const startButton = document.getElementById('startButton');
            startButton.disabled = !selectedToken || !account || isMinting;
            document.getElementById('stopButton').style.display = isMinting ? 'block' : 'none';
        }

        async function initializeAccount() {
            const privateKey = document.getElementById('privateKeyInput').value.trim();

            if (!privateKey) {
                appendLog('Please enter a private key', 'error');
                return;
            }

            try {
                account = web3.eth.accounts.privateKeyToAccount(privateKey);
                web3.eth.accounts.wallet.add(account);
                appendLog(`Account loaded: ${account.address.slice(0, 6)}...${account.address.slice(-4)}`, 'success');
                momongaContract = new web3.eth.Contract(momongaAbi, momongaAddress);
                updateButtons();
            } catch (error) {
                appendLog(`Failed to load account: ${error.message}`, 'error');
                account = null;
                updateButtons();
            }
        }

        async function getNextNonce(address) {
            try {
                const pendingNonce = await web3.eth.getTransactionCount(address, 'pending');
                const latestNonce = await web3.eth.getTransactionCount(address, 'latest');
                const nextNonce = Math.max(pendingNonce, latestNonce);
                return nextNonce;
            } catch (error) {
                appendLog(`Error fetching nonce: ${error.message}`, 'error');
                return null;
            }
        }

        async function updateGasPrice() {
            try {
                const gasPrice = await web3.eth.getGasPrice();
                let fastGasPrice = web3.utils.toBN(gasPrice);
                fastGasPrice = web3.utils.toBN(Math.max(
                    web3.utils.toWei(GAS_PRICE_MIN_GWEI, 'gwei'),
                    Math.min(fastGasPrice, web3.utils.toWei(GAS_PRICE_MAX_GWEI, 'gwei'))
                ));
                appendLog(`Updated gasPrice: ${web3.utils.fromWei(fastGasPrice, 'gwei')} Gwei`, 'info');
                return fastGasPrice;
            } catch (error) {
                const fallback = web3.utils.toWei('2', 'gwei');
                appendLog(`Failed to update gasPrice, using fallback: 2 Gwei`, 'error');
                return fallback;
            }
        }

        async function waitForTransaction(txHash) {
            const maxAttempts = 60;
            let attempts = 0;
            while (attempts < maxAttempts) {
                try {
                    const receipt = await web3.eth.getTransactionReceipt(txHash);
                    if (receipt) {
                        if (receipt.status) return receipt;
                        throw new Error(`Transaction ${txHash} failed`);
                    }
                } catch (error) {
                    appendLog(`Error checking transaction ${txHash}: ${error.message}`, 'error');
                }
                await new Promise(resolve => setTimeout(resolve, 2000));
                attempts++;
            }
            throw new Error(`Transaction ${txHash} not confirmed after ${maxAttempts} attempts`);
        }

        async function withRetry(fn, maxRetries = 3, delay = 2000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await fn();
                } catch (error) {
                    if (error.message.includes('nonce too low')) {
                        // Silently retry with a fresh nonce
                        return null;
                    }
                    if (attempt === maxRetries) {
                        appendLog(`Error after ${maxRetries} retries: ${error.message}`, 'error');
                        throw error;
                    }
                    appendLog(`Retrying (${attempt}/${maxRetries}): ${error.message}`, 'error');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function mintMomo() {
            if (!isMinting) return false;

            const tokenAddress = selectedToken;
            if (!account) {
                appendLog('Please enter a valid private key', 'error');
                return false;
            }
            if (!tokenAddress) {
                appendLog('Please select a token', 'error');
                return false;
            }

            try {
                const balance = await web3.eth.getBalance(account.address);
                if (web3.utils.fromWei(balance, 'ether') < 0.01) {
                    appendLog(`Low BONE balance (< 0.01) for ${account.address.slice(0, 8)}`, 'error');
                    return false;
                }

                const nonce = await getNextNonce(account.address);
                if (nonce === null) {
                    appendLog('Failed to fetch nonce, aborting mint', 'error');
                    return false;
                }

                const gasPrice = await updateGasPrice();
                const gasLimit = parseInt(document.getElementById('gasLimit').value);

                appendLog(`Minting MOMO with token ${tokenAddress} for ${account.address.slice(0, 8)}, nonce: ${nonce}, gasPrice: ${web3.utils.fromWei(gasPrice, 'gwei')} Gwei`, 'info');

                const txObject = {
                    from: account.address,
                    to: momongaAddress,
                    gas: web3.utils.toHex(gasLimit),
                    gasPrice: web3.utils.toHex(gasPrice),
                    nonce: web3.utils.toHex(nonce),
                    data: momongaContract.methods.mint(tokenAddress).encodeABI()
                };

                const signedTx = await web3.eth.accounts.signTransaction(txObject, account.privateKey);
                const tx = await withRetry(() => web3.eth.sendSignedTransaction(signedTx.rawTransaction));

                if (tx === null) {
                    // Nonce too low, silently retry with fresh nonce in next call
                    return false;
                }

                appendLog(`Transaction submitted. Hash: ${tx.transactionHash}`, 'info');
                await waitForTransaction(tx.transactionHash);
                appendLog('MOMO minted successfully!', 'success');
                return true;
            } catch (error) {
                let errorMessage = error.message || 'Unknown error';
                if (error.message.includes('revert')) {
                    errorMessage = error.message.split('revert')[1]?.trim() || 'Revert reason unknown';
                } else if (error.message.includes('Invalid JSON RPC response')) {
                    errorMessage = 'Failed to connect to Shibarium RPC. Please check network.';
                }
                appendLog(`Mint failed: ${errorMessage}`, 'error');
                return false;
            }
        }

        async function startMinting() {
            if (!account || !selectedToken) {
                appendLog('Please provide a private key and select a token', 'error');
                return;
            }

            isMinting = true;
            document.getElementById('startButton').style.display = 'none';
            document.getElementById('stopButton').style.display = 'block';
            appendLog('Started minting process', 'success');

            while (isMinting) {
                const success = await mintMomo();
                if (!success) {
                    // Failed (e.g., nonce too low, balance, revert), try again immediately
                    continue;
                }
                // Success, proceed to next mint
            }
        }

        function stopMinting() {
            isMinting = false;
            document.getElementById('startButton').style.display = 'block';
            document.getElementById('stopButton').style.display = 'none';
            appendLog('Minting stopped', 'info');
        }

        document.getElementById('privateKeyInput').addEventListener('input', initializeAccount);
        document.getElementById('startButton').addEventListener('click', startMinting);
        document.getElementById('stopButton').addEventListener('click', stopMinting);
        initializeCustomSelect();
    </script>
</body>
</html>
